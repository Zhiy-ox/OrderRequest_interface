<!DOCTYPE html>
<html lang="en">
<!--
  Supervisor Dashboard with Pending, Approved, and Archived Tabs
  - Archived tab now shows all "Finished" items automatically.
  - "Archived" removed from decision options.
  - No manual archive button.
  - Enhanced showError to display HTTP status and response body.
  - Added Attachments column with view & copy-URL buttons.
-->
<head>
  <meta charset="UTF-8" />
  <title>Supervisor Order Review Dashboard</title>
  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <!-- Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
  />
  <!-- AOS CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css"
  />
  <style>
    body { background: #f6f8fa; }
    .dashboard-container { padding: 2rem; }
    .card { border: none; border-radius: 0.7rem; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
    table thead th { background: #e9ecef; border-bottom: 2px solid #dee2e6; }
    table tbody tr { transition: background 0.18s ease; }
    table tbody tr:hover { background: #f1f5f9; }
    .preserve-lines { white-space: pre-wrap; word-wrap: break-word; }
    .btn-submit { transition: transform 0.2s, box-shadow 0.2s; }
    .btn-submit:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    .btn-submit:active { transform: none; box-shadow: none; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
      <span class="navbar-brand">Supervisor Dashboard</span>
    </div>
  </nav>

  <div class="container-fluid dashboard-container">
    <h2 class="mb-3">Order Requests</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-pane">Pending <span class="badge bg-secondary" id="badge-pending">0</span></button></li>
      <li class="nav-item"><button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved-pane">Approved <span class="badge bg-secondary" id="badge-approved">0</span></button></li>
      <li class="nav-item"><button class="nav-link" id="archived-tab" data-bs-toggle="tab" data-bs-target="#archived-pane">Archived <span class="badge bg-secondary" id="badge-archived">0</span></button></li>
    </ul>

    <div class="tab-content pt-3">
      <!-- Pending -->
      <div class="tab-pane fade show active" id="pending-pane">
        <div class="card"><div class="card-body p-0">
          <div class="table-responsive" style="max-height:78vh;">
            <table class="table table-striped table-hover align-middle" id="pendingTable">
              <thead></thead>
              <tbody id="pendingBody"><tr><td colspan="16" class="text-center py-4">Loading…</td></tr></tbody>
            </table>
          </div>
        </div></div>
      </div>
      <!-- Approved -->
      <div class="tab-pane fade" id="approved-pane">
        <div class="card"><div class="card-body p-0">
          <div class="table-responsive" style="max-height:78vh;">
            <table class="table table-striped table-hover align-middle" id="approvedTable">
              <thead></thead>
              <tbody id="approvedBody"><tr><td colspan="16" class="text-center py-4">Loading…</td></tr></tbody>
            </table>
          </div>
        </div></div>
      </div>
      <!-- Archived (Finished) -->
      <div class="tab-pane fade" id="archived-pane">
        <div class="card"><div class="card-body p-0">
          <div class="table-responsive" style="max-height:78vh;">
            <table class="table table-striped table-hover align-middle" id="archivedTable">
              <thead></thead>
              <tbody id="archivedBody"><tr><td colspan="16" class="text-center py-4">Loading…</td></tr></tbody>
            </table>
          </div>
        </div></div>
      </div>
    </div>

    <!-- Alerts -->
    <div id="alertArea" class="mt-4"></div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const LIST_FETCH_URL  = "https://prod-108.westeurope.logic.azure.com/…YOUR_LIST_FETCH_SIG…";
    const UPDATE_FLOW_URL = "https://prod-168.westeurope.logic.azure.com/…YOUR_UPDATE_SIG…";
    const possibleDecisions = ["Undecided","Followup","Ordered","Denied","Approved","Finished"];

    // ——— Alert helpers ———
    function showError(msg) {
      const area = document.getElementById('alertArea');
      area.innerHTML = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <strong>Error:</strong> ${msg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      area.scrollIntoView({ behavior: 'smooth' });
    }
    function showInfo(msg) {
      const area = document.getElementById('alertArea');
      area.innerHTML = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          ${msg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      area.scrollIntoView({ behavior: 'smooth' });
    }

    // ——— Attachment URL utilities ———
    function openInNewTab(url) {
      window.open(url, '_blank', 'noopener');
    }
    function copyUrlToClipboard(url) {
      navigator.clipboard.writeText(url)
        .then(() => showInfo('Attachment URL copied to clipboard.'))
        .catch(err => showError('Failed to copy URL: ' + err));
    }

    const fmt = iso => !iso ? "" : new Date(iso).toLocaleString("en-GB", {
      year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'
    });
    function makeOption(value, selected) {
      const o = document.createElement('option');
      o.value = value; o.textContent = value;
      if (value === selected) o.selected = true;
      return o;
    }

    function buildRow(item, mode, idx) {
      const tr = document.createElement('tr');
      tr.dataset.id = item.ID;
      tr.setAttribute('data-aos','fade-up');
      tr.setAttribute('data-aos-delay',idx*60);
      const addCell = (c, cls) => {
        const td = document.createElement('td');
        if (cls) td.className = cls;
        if (c instanceof Node) td.appendChild(c);
        else td.innerHTML = c;
        tr.appendChild(td);
      };

      // … existing cells for ID, request fields, …  

      // Comments
      if (mode !== 'archived') {
        const ta = Object.assign(document.createElement('textarea'), {
          className: 'form-control form-control-sm',
          rows: 2,
          id: `comments-${item.ID}`
        });
        ta.value = item.Comments_by_Supervisor || '';
        addCell(ta);
      } else {
        addCell(item.Comments_by_Supervisor || '');
      }

      // Attachments
      if (Array.isArray(item.Attachments) && item.Attachments.length) {
        const div = document.createElement('div');
        div.className='preserve-lines';
        item.Attachments.forEach(att => {
          const a = document.createElement('a');
          a.href='#';
          a.textContent = att.FileName;
          a.onclick = e => { e.preventDefault(); openInNewTab(att.Url); };

          const copyBtn = document.createElement('button');
          copyBtn.type = 'button';
          copyBtn.className = 'btn btn-sm btn-outline-secondary ms-2';
          copyBtn.title = 'Copy URL';
          copyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
          copyBtn.onclick = () => copyUrlToClipboard(att.Url);

          div.appendChild(a);
          div.appendChild(copyBtn);
          div.appendChild(document.createElement('br'));
        });
        addCell(div);
      } else {
        addCell('—');
      }

      // Action button
      const tdAct = document.createElement('td');
      if (mode !== 'archived') {
        const btn = Object.assign(document.createElement('button'), {
          className: 'btn btn-primary btn-sm btn-submit',
          innerHTML: '<i class="bi bi-send"></i>'
        });
        btn.onclick = () => submitUpdate(item.ID);
        tdAct.appendChild(btn);
      }
      tr.appendChild(tdAct);

      return tr;
    }

    // ——— loadData now uses GET, no body ———
    async function loadData() {
      const bodies = [
        document.getElementById('pendingBody'),
        document.getElementById('approvedBody'),
        document.getElementById('archivedBody')
      ];
      bodies.forEach(b => b.innerHTML = '');

      try {
        // ← No POST, just GET:
        const res = await fetch(LIST_FETCH_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const pending  = data.filter(i => !['Approved','Finished'].includes(i.Decision?.Value));
        const approved = data.filter(i => i.Decision?.Value === 'Approved');
        const archived = data.filter(i => i.Decision?.Value === 'Finished');

        document.getElementById('badge-pending').textContent  = pending.length;
        document.getElementById('badge-approved').textContent = approved.length;
        document.getElementById('badge-archived').textContent = archived.length;

        pending.forEach((it, idx)   => bodies[0].appendChild(buildRow(it,'pending',   idx)));
        approved.forEach((it, idx)  => bodies[1].appendChild(buildRow(it,'approved',  idx)));
        archived.forEach((it, idx)  => bodies[2].appendChild(buildRow(it,'archived',  idx)));

        if (pending.length + approved.length + archived.length === 0) {
          bodies[0].innerHTML = '<tr><td colspan="16" class="text-center py-4">No orders found</td></tr>';
        }

        AOS.init({ duration: 650, once: true });
      } catch (e) {
        showError(`Failed to load orders: ${e.message}`);
        document.getElementById('pendingBody').innerHTML =
          '<tr><td colspan="16" class="text-center py-4 text-danger">Error loading data</td></tr>';
      }
    }

    async function submitUpdate(id) {
      // … unchanged …
    }

    document.addEventListener('DOMContentLoaded', () => {
      // insert headers, then…
      loadData();
    });
  </script>
</body>
</html>
