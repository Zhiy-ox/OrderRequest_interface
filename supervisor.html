<!DOCTYPE html>
<html lang="en">
<!--  
  Supervisor Dashboard with Pending, Approved, and Archived Tabs + Bottom Error Alerts
  - Adds reusable showError() utility that renders Bootstrap dismissible alerts at the bottom.
-->
<head>
  <meta charset="UTF-8" />
  <title>Supervisor Order Review Dashboard</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
  <!-- AOS CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />
  <style>
    body{background:#f6f8fa;}
    .dashboard-container{padding:2rem;}
    .card{border:none;border-radius:.7rem;box-shadow:0 3px 10px rgba(0,0,0,.08);}  
    table thead th{background:#e9ecef;border-bottom:2px solid #dee2e6;}
    table tbody tr{transition:background .18s ease;}
    table tbody tr:hover{background:#f1f5f9;}
    .preserve-lines{white-space:pre-wrap;word-wrap:break-word;}
    .btn-submit{transition:transform .2s,box-shadow .2s;}
    .btn-submit:hover{transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.15);} 
    .btn-submit:active{transform:none;box-shadow:none;}
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid"><span class="navbar-brand">Supervisor Dashboard</span></div>
  </nav>

  <div class="container-fluid dashboard-container">
    <h2 class="mb-3">Order Requests</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-pane" type="button" role="tab">Pending <span class="badge bg-secondary" id="badge-pending">0</span></button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved-pane" type="button" role="tab">Approved <span class="badge bg-secondary" id="badge-approved">0</span></button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="archived-tab" data-bs-toggle="tab" data-bs-target="#archived-pane" type="button" role="tab">Archived <span class="badge bg-secondary" id="badge-archived">0</span></button>
      </li>
    </ul>

    <div class="tab-content pt-3">
      <!-- Pending -->
      <div class="tab-pane fade show active" id="pending-pane" role="tabpanel">
        <div class="card"><div class="card-body p-0">
          <div class="table-responsive" style="max-height:78vh;">
            <table class="table table-striped table-hover align-middle" id="pendingTable">
              <thead></thead>
              <tbody id="pendingBody"><tr><td colspan="15" class="text-center py-4">Loading…</td></tr></tbody>
            </table>
          </div>
        </div></div>
      </div>
      <!-- Approved -->
      <div class="tab-pane fade" id="approved-pane" role="tabpanel">
        <div class="card"><div class="card-body p-0">
          <div class="table-responsive" style="max-height:78vh;">
            <table class="table table-striped table-hover align-middle" id="approvedTable">
              <thead></thead>
              <tbody id="approvedBody"><tr><td colspan="15" class="text-center py-4">Loading…</td></tr></tbody>
            </table>
          </div>
        </div></div>
      </div>
      <!-- Archived -->
      <div class="tab-pane fade" id="archived-pane" role="tabpanel">
        <div class="card"><div class="card-body p-0">
          <div class="table-responsive" style="max-height:78vh;">
            <table class="table table-striped table-hover align-middle" id="archivedTable">
              <thead></thead>
              <tbody id="archivedBody"><tr><td colspan="15" class="text-center py-4">Loading…</td></tr></tbody>
            </table>
          </div>
        </div></div>
      </div>
    </div>

    <!-- Error / status alerts -->
    <div id="alertArea" class="mt-4"></div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Endpoints
    const LIST_FETCH_URL="https://prod-108.westeurope.logic.azure.com:443/workflows/82ca49f033d84aa8807da35568348a60/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=OnER2k0ivse9M9rXp7mwortbxjGFVuPvn1OZsMHqhXs";
    const UPDATE_FLOW_URL="https://prod-168.westeurope.logic.azure.com:443/workflows/0d2ecc042a8745f58b40ae8e35cdc47b/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=am6h8CwzxHZWuBRAmtmhVTdaUVkBihbJP7X4LWsV3Xo";

    const possibleDecisions=["Undecided","Followup","Finished","Ordered","Denied","Approved","Archived"];

    // Inject common header into all 3 tables
    const headerHTML=`<tr><th>ID</th><th>Requester Name</th><th>Materials / Equipment Name</th><th>Quantity</th><th>Unit</th><th>Reason</th><th>Links</th><th>Tracking URL</th><th>Submitted Time</th><th>Decision</th><th>Cost</th><th>Currency</th><th>Supply Code</th><th>Comments</th><th>Action</th></tr>`;
    document.querySelectorAll('table thead').forEach(el=>el.innerHTML=headerHTML);

    // ---------- Utility: show error alert at bottom ----------
    function showError(msg){
      const alertArea=document.getElementById('alertArea');
      alertArea.innerHTML=`<div class="alert alert-danger alert-dismissible fade show" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
      // scroll into view for visibility
      alertArea.scrollIntoView({behavior:'smooth'});
    }

    // success/info optional helper (not strictly requested)
    function showInfo(msg){
      const alertArea=document.getElementById('alertArea');
      alertArea.innerHTML=`<div class="alert alert-success alert-dismissible fade show" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
      alertArea.scrollIntoView({behavior:'smooth'});
    }

    const fmt=iso=>!iso?"":new Date(iso).toLocaleString("en-GB",{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    const opt=(v,sel)=>{const o=document.createElement('option');o.value=v;o.textContent=v;if(v===sel)o.selected=true;return o;};

    function buildRow(item,mode,i){
      const tr=document.createElement('tr');tr.dataset.id=item.ID;tr.setAttribute('data-aos','fade-up');tr.setAttribute('data-aos-delay',i*60);
      const td=(html,cls)=>{const d=document.createElement('td');if(cls)d.className=cls;if(html instanceof Node)d.appendChild(html);else d.innerHTML=html;tr.appendChild(d);};
      td(item.ID||"");td(item.RequesterName?.DisplayName||"");td(item.Materials_or_Equipment_Name||"");td(item.Quantity||"");td(item.Unit||"");td(item.Reason||"","preserve-lines");
      // link cell
      const link=item.Link_of_Materials_or_Equipment?Object.assign(document.createElement('a'),{href:item.Link_of_Materials_or_Equipment,target:'_blank',textContent:'View'}):'';td(link);
      // tracking
      if(mode!=='archived'){const inp=Object.assign(document.createElement('input'),{type:'url',className:'form-control form-control-sm',value:item.The_Order_Tracking_URL||'',id:`track-${item.ID}`});td(inp);}else td(item.The_Order_Tracking_URL||"");
      td(fmt(item.Order_Submitted_Time));
      // decision
      if(mode!=='archived'){const sel=Object.assign(document.createElement('select'),{className:'form-select form-select-sm',id:`decision-${item.ID}`});possibleDecisions.forEach(d=>sel.appendChild(opt(d,item.Decision?.Value||'Undecided')));td(sel);}else td(item.Decision?.Value||"");
      td(item.Cost||"");td(item.Currency||"");td(item.Supply_Code||"");
      // comments
      if(mode!=='archived'){const ta=Object.assign(document.createElement('textarea'),{className:'form-control form-control-sm',rows:2,id:`comments-${item.ID}`,value:item.Comments_by_Supervisor||''});td(ta);}else td(item.Comments_by_Supervisor||"");
      // actions
      const act=document.createElement('td');
      if(mode!=='archived'){
        const btn=Object.assign(document.createElement('button'),{className:'btn btn-primary btn-sm btn-submit me-1',innerHTML:'<i class="bi bi-send"></i>'});btn.onclick=()=>submitUpdate(item.ID);act.appendChild(btn);
        if(mode==='approved'){
          const arch=Object.assign(document.createElement('button'),{className:'btn btn-outline-secondary btn-sm',innerHTML:'<i class="bi bi-archive"></i>'});arch.onclick=()=>archiveOrder(item.ID);act.appendChild(arch);
        }
      }
      tr.appendChild(act);
      return tr;
    }

    async function loadData(){
      const bodies=['pendingBody','approvedBody','archivedBody'].map(id=>document.getElementById(id));bodies.forEach(b=>b.innerHTML='');
      try{
        const res=await fetch(LIST_FETCH_URL);if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data=await res.json();
        const pending=data.filter(i=>!['Approved','Archived'].includes(i.Decision?.Value));
        const approved=data.filter(i=>i.Decision?.Value==='Approved');
        const archived=data.filter(i=>i.Decision?.Value==='Archived');
        // badges
        document.getElementById('badge-pending').textContent=pending.length;document.getElementById('badge-approved').textContent=approved.length;document.getElementById('badge-archived').textContent=archived.length;
        // render
        pending.forEach((it,idx)=>bodies[0].appendChild(buildRow(it,'pending',idx)));
        approved.forEach((it,idx)=>bodies[1].appendChild(buildRow(it,'approved',idx)));
        archived.forEach((it,idx)=>bodies[2].appendChild(buildRow(it,'archived',idx)));
        if(pending.length+approved.length+archived.length===0)bodies[0].innerHTML='<tr><td colspan="15" class="text-center py-4">No orders found</td></tr>';
        AOS.init({duration:650,once:true});
      }catch(e){showError('Failed to load orders: '+e.message); bodies[0].innerHTML='<tr><td colspan="15" class="text-center py-4 text-danger">Error loading data</td></tr>';}
    }

    function submitUpdate(id){
      const row=document.querySelector(`tr[data-id="${id}"]`);if(!row)return;const btn=row.querySelector('button.btn-submit');
      const payload={ID:id,The_Order_Tracking_URL:document.getElementById(`track-${id}`)?.value.trim(),Decision:document.getElementById(`decision-${id}`)?.value.trim(),Comments_by_Supervisor:document.getElementById(`comments-${id}`)?.value.trim()};
      btn.disabled=true;btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>';
      fetch(UPDATE_FLOW_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        .then(r=>{btn.disabled=false;btn.innerHTML='<i class="bi bi-send"></i>';if(r.ok){row.classList.add('table-success');setTimeout(()=>row.classList.remove('table-success'),2000);}else{showError('Update failed for ID '+id);row.classList.add('table-danger');setTimeout(()=>row.classList.remove('table-danger'),2000);}})
        .catch(err=>{btn.disabled=false;btn.innerHTML='<i class="bi bi-send"></i>';showError('Network error while updating ID '+id+': '+err.message);row.classList.add('table-danger');setTimeout(()=>row.classList.remove('table-danger'),2000);});
    }

    function archiveOrder(id){
      const row=document.querySelector(`tr[data-id="${id}"]`);if(!row)return;const btn=row.querySelector('button.btn-outline-secondary');
      btn.disabled=true;btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>';
      fetch(UPDATE_FLOW_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ID:id,Decision:'Archived'})})
        .then(r=>{btn.disabled=false;btn.innerHTML='<i class="bi bi-archive"></i>';if(r.ok){loadData();showInfo('Order '+id+' archived');}else{showError('Archiving failed for ID '+id);row.classList.add('table-danger');setTimeout(()=>row.classList.remove('table-danger'),2000);}})
        .catch(err=>{btn.disabled=false;btn.innerHTML='<i class="bi bi-archive"></i>';showError('Network error while archiving ID '+id+': '+err.message);row.classList.add('table-danger');setTimeout(()=>row.classList.remove('table-danger'),2000);});
    }

    document.addEventListener('DOMContentLoaded',loadData);
  </script>
</body>
</html>
