<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Supervisor Approval</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <style>
    /* Preserves line breaks for multi-line text fields */
    .preserve-lines {
      white-space: pre-wrap;  
      word-wrap: break-word;  
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row">
      <div class="col-12">
        <h2>Supervisor Dashboard</h2>
        <p>Review the order requests (with attachments).</p>

        <!-- Button to load requests from SharePoint (or a Flow that fetches from SharePoint) -->
        <button id="loadBtn" class="btn btn-success mb-3">Load Requests</button>

        <!-- Enforce column widths using colgroup + table-layout:fixed -->
        <table
          class="table table-bordered table-striped"
          id="requestsTable"
          style="table-layout: fixed; width: 100%;"
        >
          <colgroup>
            <col style="width: 50px;" />
            <col style="width: 150px;" />
            <col style="width: 200px;" />
            <col style="width: 80px;" />
            <col style="width: 80px;" />
            <col style="width: 400px;" />
            <col style="width: 200px;" />
            <col style="width: 200px;" />
            <col style="width: 160px;" />
            <col style="width: 150px;" />
            <col style="width: 80px;" />
            <col style="width: 80px;" />
            <col style="width: 120px;" />
            <col style="width: 200px;" />
            <col style="width: 200px;" /> <!-- NEW: Attachments column -->
            <col style="width: 100px;" />
          </colgroup>

          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Requester Name</th>
              <th>Materials or Equipment Name</th>
              <th>Quantity</th>
              <th>Unit</th>
              <th>Reason</th>
              <th>Links of Materials or Equipment</th>
              <th>The Order Tracking URL</th>
              <th>Order Submitted Time</th>
              <th>Decision</th>
              <th>Cost</th>
              <th>Currency</th>
              <th>Supply_Code</th>
              <th>Comments by Supervisor</th>
              <th>Attachments</th> <!-- NEW -->
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamically populated rows -->
          </tbody>
        </table>

        <div id="responseMessage" class="text-danger fw-bold"></div>
      </div>
    </div>
  </div>

  <!-- Optional Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // 1) URL that returns the JSON array of orders (Power Automate GET flow)
    const LIST_FETCH_URL = "YOUR_FLOW_URL_FOR_GET_HERE";

    // 2) URL for supervisor approvals (Power Automate POST flow) to update existing items
    const UPDATE_FLOW_URL = "YOUR_FLOW_URL_FOR_POST_HERE";

    const loadBtn = document.getElementById("loadBtn");
    const requestsTableBody = document.querySelector("#requestsTable tbody");
    const responseMessage = document.getElementById("responseMessage");

    // Possible decisions for the dropdown
    const possibleDecisions = [
      "Undecided",
      "Followup",
      "Finished",
      "Ordered",
      "Denied",
      "Approved"
    ];

    // Load existing requests from your GET flow/SharePoint
    loadBtn.addEventListener("click", async () => {
      responseMessage.textContent = "";
      try {
        const res = await fetch(LIST_FETCH_URL);
        if (!res.ok) {
          throw new Error("Failed to fetch requests.");
        }

        // If your Flow returns { "value": [...] }, grab the .value
        const dataObj = await res.json();
        // dataObj might be { "value": [ {...}, {...} ] }
        const data = dataObj.value || [];

        // Sort items by Decision
        data.sort((a, b) => {
          const decisionA = a.Decision?.Value || "Undecided";
          const decisionB = b.Decision?.Value || "Undecided";
          const indexA = possibleDecisions.indexOf(decisionA);
          const indexB = possibleDecisions.indexOf(decisionB);
          const safeA = indexA === -1 ? possibleDecisions.length : indexA;
          const safeB = indexB === -1 ? possibleDecisions.length : indexB;
          return safeA - safeB;
        });

        // Clear existing rows
        requestsTableBody.innerHTML = "";

        // Populate table rows
        data.forEach((item) => {
          const row = document.createElement("tr");
          row.setAttribute("data-id", item.ID || "");

          // Format date if it exists
          let submittedTime = "";
          if (item.Order_submitted_Time) {
            const dateObj = new Date(item.Order_submitted_Time);
            submittedTime = dateObj.toLocaleString("en-US", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
              hour12: true
            });
          }

          // Build attachments HTML
          let attachmentsHtml = "No attachments";
          if (item.Attachments && Array.isArray(item.Attachments) && item.Attachments.length > 0) {
            attachmentsHtml = item.Attachments
              .map((att) => `<a href="${att.Url}" target="_blank">${att.Name}</a>`)
              .join("<br/>");
          }

          // Construct each cell
          const rowHtml = `
            <td>${item.ID || ""}</td>
            <td>${item.Requester_Name?.DisplayName || ""}</td>
            <td>${item.Materials_or_Equipment_Name || ""}</td>
            <td>${item.Quantity ?? "No quantity"}</td>
            <td>${item.Unit || "No unit provided"}</td>
            <td class="preserve-lines">${item.Reason || "No Proposal Provided"}</td>
            <td>${item.Link_of_Materials_or_Equipment || "No Link Provided"}</td>
            <td class="trackingUrlCell">${item.The_Order_Tracking_URL || ""}</td>
            <td>${submittedTime}</td>
            <td class="decisionCell">${item.Decision?.Value || "Undecided"}</td>
            <td>${item.Cost ?? "No cost provided"}</td>
            <td>${item.Currency || ""}</td>
            <td>${item.Supply_Code || "No supply code provided"}</td>
            <td class="commentsCell">${item.Comments_by_Supervisor || ""}</td>
            <td class="attachmentsCell">${attachmentsHtml}</td>
            <td>
              <button class="btn btn-sm btn-primary editBtn">Edit</button>
              <button class="btn btn-sm btn-success saveBtn" style="display:none;">Save</button>
            </td>
          `;

          row.innerHTML = rowHtml;
          requestsTableBody.appendChild(row);
        });

        addRowListeners();
      } catch (err) {
        console.error(err);
        responseMessage.textContent = "Error loading requests: " + err.message;
      }
    });

    // Attach Edit/Save event listeners for each row
    function addRowListeners() {
      const allRows = document.querySelectorAll("#requestsTable tbody tr");

      allRows.forEach((row) => {
        const editBtn = row.querySelector(".editBtn");
        const saveBtn = row.querySelector(".saveBtn");

        editBtn.addEventListener("click", () => {
          const trackingCell = row.querySelector(".trackingUrlCell");
          const decisionCell = row.querySelector(".decisionCell");
          const commentsCell = row.querySelector(".commentsCell");

          // Current values
          const currentTrackingUrl = trackingCell.textContent.trim();
          const currentDecision = decisionCell.textContent.trim();
          const currentComments = commentsCell.textContent.trim();

          // Convert the tracking URL cell to a text input
          trackingCell.innerHTML = `<input type="text" class="form-control" value="${currentTrackingUrl}" />`;

          // Convert the decision cell to a dropdown
          let selectHtml = `<select class="form-select">`;
          possibleDecisions.forEach((option) => {
            const selected = option === currentDecision ? "selected" : "";
            selectHtml += `<option value="${option}" ${selected}>${option}</option>`;
          });
          selectHtml += `</select>`;
          decisionCell.innerHTML = selectHtml;

          // Convert the comments cell to a textarea
          commentsCell.innerHTML = `<textarea class="form-control" rows="3">${currentComments}</textarea>`;

          editBtn.style.display = "none";
          saveBtn.style.display = "inline-block";
        });

        saveBtn.addEventListener("click", async () => {
          const trackingCell = row.querySelector(".trackingUrlCell");
          const decisionCell = row.querySelector(".decisionCell");
          const commentsCell = row.querySelector(".commentsCell");

          // Get new values
          const newTrackingUrl = trackingCell.querySelector("input").value.trim();
          const newDecision = decisionCell.querySelector("select").value.trim();
          const newComments = commentsCell.querySelector("textarea").value.trim();

          const rowId = row.getAttribute("data-id");

          try {
            responseMessage.textContent = "Updating item...";

            const payload = {
              ID: rowId,
              The_Order_Tracking_URL: newTrackingUrl,
              Decision: newDecision,
              Comments_by_Supervisor: newComments
              // Add more fields if needed
            };

            const res = await fetch(UPDATE_FLOW_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            if (!res.ok) {
              throw new Error(`Update request failed with status ${res.status}`);
            }

            responseMessage.textContent = `Item #${rowId} updated successfully.`;

            // Revert cells to plain text
            trackingCell.textContent = newTrackingUrl || "Please insert Tracking URL";
            decisionCell.textContent = newDecision || "Undecided";
            commentsCell.textContent = newComments || "";

            editBtn.style.display = "inline-block";
            saveBtn.style.display = "none";
          } catch (error) {
            console.error(error);
            responseMessage.textContent = `Error updating item #${rowId}: ${error.message}`;
          }
        });
      });
    }
  </script>
</body>
</html>
