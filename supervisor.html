<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMP Order System | Soft Matter Photonics</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map for React modules -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
      }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
            animation: blob 15s infinite;
        }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0; 
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.8); }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .glass-sidebar {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
            transition: all 0.2s ease;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased selection:bg-indigo-100 selection:text-indigo-800 overflow-hidden relative">
    
    <!-- Fluid Background Blobs -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
        <div class="absolute top-0 -left-4 w-96 h-96 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob"></div>
        <div class="absolute top-0 -right-4 w-96 h-96 bg-indigo-300 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-20 w-96 h-96 bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob animation-delay-4000"></div>
    </div>

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useCallback, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          CheckCircle2, XCircle, AlertCircle, Search, Filter, Bell, Menu, User, 
          FileText, History, MoreHorizontal, ArrowUpRight, Building2, Calendar, 
          Download, Briefcase, CreditCard, X, Microscope, Beaker, Zap, 
          GraduationCap, ScrollText, Loader2, RefreshCw, Link as LinkIcon, 
          Truck, Layers, Hexagon, Sparkles, MessageSquare, Shield, Eye, FileWarning, TrendingUp
        } from 'lucide-react';

        // --- CONFIGURATION: POWER AUTOMATE ENDPOINTS ---
        const API_CONFIG = {
          GET_URL: 'https://prod-108.westeurope.logic.azure.com:443/workflows/82ca49f033d84aa8807da35568348a60/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=OnER2k0ivse9M9rXp7mwortbxjGFVuPvn1OZsMHqhXs',
          UPDATE_URL: 'https://prod-168.westeurope.logic.azure.com:443/workflows/0d2ecc042a8745f58b40ae8e35cdc47b/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=am6h8CwzxHZWuBRAmtmhVTdaUVkBihbJP7X4LWsV3Xo'
        };
        
        const CACHE_KEY = 'smp_orders_cache';

        // --- GEMINI API CONFIG ---
        const GEMINI_API_KEY = ""; // Provided by environment

        // --- INLINE SVG: DEPARTMENT OF ENGINEERING SCIENCE LOGO ---
        const EngineeringLogo = () => (
            <svg viewBox="0 0 800 220" className="w-full h-full drop-shadow-sm" fill="none" xmlns="http://www.w3.org/2000/svg">
                {/* Shield Group */}
                <g id="shield" transform="translate(0, 10) scale(0.6)">
                    <path d="M150 295C150 295 250 250 250 130V40H50V130C50 250 150 295 150 295Z" fill="#002147" stroke="#FFFFFF" strokeWidth="5"/>
                    <path d="M150 130V40H50V130H150Z" fill="#002147"/>
                    <path d="M250 130V40H150V130H250Z" fill="#002147"/>
                    <path d="M150 295C150 295 50 250 50 130H150V295Z" fill="#002147"/>
                    <path d="M150 295C150 295 250 250 250 130H150V295Z" fill="#002147"/>
                    
                    {/* Open Book */}
                    <rect x="90" y="70" width="120" height="90" fill="#FFFFFF"/>
                    <text x="115" y="100" fontSize="20" fill="#002147" fontFamily="serif" fontWeight="bold">DOMI</text>
                    <text x="165" y="100" fontSize="20" fill="#002147" fontFamily="serif" fontWeight="bold">MINA</text>
                    <text x="115" y="125" fontSize="20" fill="#002147" fontFamily="serif" fontWeight="bold">NVS</text>
                    <text x="165" y="125" fontSize="20" fill="#002147" fontFamily="serif" fontWeight="bold">TIO</text>
                    <text x="115" y="150" fontSize="20" fill="#002147" fontFamily="serif" fontWeight="bold">ILLV</text>
                    <text x="165" y="150" fontSize="20" fill="#002147" fontFamily="serif" fontWeight="bold">MEA</text>
                    
                    {/* Crowns */}
                    <path d="M100 30 L110 50 L120 30 L130 50 L140 30 L140 55 L100 55 Z" fill="#F1BE48" />
                    <path d="M160 30 L170 50 L180 30 L190 50 L200 30 L200 55 L160 55 Z" fill="#F1BE48" />
                    <path d="M130 200 L140 220 L150 200 L160 220 L170 200 L170 225 L130 225 Z" fill="#F1BE48" />
                </g>
                
                {/* Vertical Separator Line */}
                <line x1="180" y1="20" x2="180" y2="180" stroke="#FFFFFF" strokeWidth="2" opacity="0.5" />
                
                {/* Text Group */}
                <g transform="translate(200, 40)">
                    <text x="0" y="35" fontSize="28" fill="#FFFFFF" fontFamily="sans-serif" letterSpacing="1" fontWeight="400">DEPARTMENT OF</text>
                    <text x="0" y="85" fontSize="42" fill="#FFFFFF" fontFamily="serif" letterSpacing="0.5" fontWeight="bold">ENGINEERING</text>
                    <text x="0" y="135" fontSize="42" fill="#FFFFFF" fontFamily="serif" letterSpacing="0.5" fontWeight="bold">SCIENCE</text>
                </g>
            </svg>
        );

        // --- API HELPER FUNCTIONS ---
        const fetchFromSharePoint = async () => {
          try {
            const response = await fetch(API_CONFIG.GET_URL, {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
          } catch (error) {
            console.error("API Error:", error);
            return null;
          }
        };

        const sendUpdateToSharePoint = async (id, decision, trackingUrl, comment) => {
          try {
            const payload = {
              ID: id,
              The_Order_Tracking_URL: trackingUrl || "N/A",
              Decision: decision,
              Comments_by_Supervisor: comment || ""
            };
            const response = await fetch(API_CONFIG.UPDATE_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            return response.ok;
          } catch (error) {
            console.error("API Error:", error);
            return false;
          }
        };

        // --- MOCK DATA (Soft Matter Context) ---
        const MOCK_REQUISITIONS = [
          {
            id: 'REQ-2024-201',
            requestor: 'Liam Zhang (PhD)',
            group: 'LC Dynamics',
            requestDate: '2024-11-18',
            total: 1250.00,
            currency: 'USD',
            status: 'Undecided',
            priority: 'High',
            description: '5CB Liquid Crystal & Alignment Layers',
            grantId: 'ERC-SOFT-LIGHT',
            items: [
              { id: 1, name: '4-Cyano-4\'-pentylbiphenyl (5CB), 5g', qty: 2, unit: 'btl', price: 350.00, total: 700.00 },
              { id: 2, name: 'Polyimide SE-130 (Homeotropic)', qty: 1, unit: 'ea', price: 550.00, total: 550.00 }
            ],
            history: [{ date: '2024-11-18 09:00', action: 'Submitted', user: 'Liam Zhang' }],
            justification: 'Replenishing stock for the new topological defect experiments. Current batch is contaminated.',
            supplier: 'Merck KGaA',
            materialLink: 'https://www.sigmaaldrich.com/',
            trackingUrl: ''
          },
          {
            id: 'REQ-2024-202',
            requestor: 'Dr. Emily Chen',
            group: 'Bio-Photonics',
            requestDate: '2024-11-19',
            total: 480.00,
            currency: 'USD',
            status: 'Undecided',
            priority: 'Normal',
            description: 'ITO Coated Glass Slides (25x25mm)',
            grantId: 'EPSRC-BIO-MAT',
            items: [
              { id: 1, name: 'ITO Glass, 100nm, 20 ohm/sq', qty: 5, unit: 'pack', price: 96.00, total: 480.00 }
            ],
            history: [{ date: '2024-11-19 11:30', action: 'Submitted', user: 'Emily Chen' }],
            justification: 'Substrates for electric field switching cells.',
            supplier: 'Diamond Coatings',
            trackingUrl: ''
          },
          {
            id: 'REQ-2024-198',
            requestor: 'Prof. A. Smith',
            group: 'Admin',
            requestDate: '2024-11-15',
            total: 2100.00,
            currency: 'GBP',
            status: 'Approved',
            priority: 'Normal',
            description: 'New Spin Coater Chucks',
            grantId: 'INSTITUTE-FUND',
            items: [
              { id: 1, name: 'Vacuum Chuck for 10mm Substrates', qty: 1, unit: 'ea', price: 2100.00, total: 2100.00 }
            ],
            history: [
              { date: '2024-11-15 10:00', action: 'Submitted', user: 'A. Smith' },
              { date: '2024-11-15 14:00', action: 'Approved', user: 'Finance Team' }
            ],
            justification: 'Required for small sample processing.',
            supplier: 'Laurell Technologies',
            trackingUrl: 'https://fedex.com/track/123456'
          }
        ];

        // --- SWIPEABLE LIST ITEM COMPONENT ---
        const SwipeableOrderCard = ({ order, selected, onClick, onSwipeRight, onSwipeLeft, index }) => {
            const [offsetX, setOffsetX] = useState(0);
            const [isDragging, setIsDragging] = useState(false);
            const touchStartX = useRef(0);

            const handleTouchStart = (e) => {
                touchStartX.current = e.touches[0].clientX;
                setIsDragging(true);
            };

            const handleTouchMove = (e) => {
                if (!isDragging) return;
                const currentX = e.touches[0].clientX;
                const diff = currentX - touchStartX.current;
                if (Math.abs(diff) < 150) {
                    setOffsetX(diff);
                }
            };

            const handleTouchEnd = () => {
                setIsDragging(false);
                if (offsetX > 100) {
                    onSwipeRight(order.id);
                } else if (offsetX < -100) {
                    onSwipeLeft(order.id);
                }
                setOffsetX(0);
            };

            const bgColor = offsetX > 50 ? 'bg-emerald-500' : offsetX < -50 ? 'bg-rose-500' : 'bg-slate-200';
            const opacity = Math.min(Math.abs(offsetX) / 100, 1);

            return (
                <div className="relative overflow-hidden rounded-xl mb-3 mx-2 select-none touch-pan-y">
                    <div className={`absolute inset-0 flex justify-between items-center px-6 ${bgColor} transition-colors`}>
                        <div className="flex items-center text-white font-bold" style={{ opacity: offsetX > 0 ? opacity : 0 }}>
                            <CheckCircle2 className="mr-2" /> Approve
                        </div>
                        <div className="flex items-center text-white font-bold" style={{ opacity: offsetX < 0 ? opacity : 0 }}>
                            Deny <XCircle className="ml-2" />
                        </div>
                    </div>
                    <div 
                        onClick={onClick}
                        onTouchStart={handleTouchStart}
                        onTouchMove={handleTouchMove}
                        onTouchEnd={handleTouchEnd}
                        className={`relative p-5 border-b border-slate-100/50 transition-transform bg-white/90 backdrop-blur-sm hover:bg-white cursor-pointer ${selected ? 'bg-indigo-50/90 shadow-inner ring-1 ring-indigo-100' : ''}`}
                        style={{ transform: `translateX(${offsetX}px)`, transition: isDragging ? 'none' : 'transform 0.2s ease-out' }}
                    >
                        {selected && <div className="absolute left-1 top-2 bottom-2 w-1 bg-indigo-500 rounded-full"></div>}
                        <div className="flex justify-between items-start mb-2 pointer-events-none">
                            <span className={`font-mono text-[11px] font-bold transition-colors ${selected ? 'text-indigo-600' : 'text-slate-500'}`}>#{order.id}</span>
                            <span className="text-[10px] text-slate-400 font-medium bg-white/50 px-1.5 py-0.5 rounded-md border border-white/50">{order.requestDate}</span>
                        </div>
                        <div className="flex justify-between items-center mb-3 pointer-events-none">
                            <h3 className={`text-sm font-bold truncate pr-2 ${selected ? 'text-indigo-900' : 'text-slate-700'}`}>{order.description}</h3>
                        </div>
                        <div className="flex justify-between items-center pointer-events-none">
                            <span className={`flex items-center w-fit px-2.5 py-0.5 rounded-full text-[10px] font-semibold border ${order.status === 'Undecided' ? 'bg-slate-100 text-slate-600' : 'bg-amber-100 text-amber-700'}`}>
                                {order.status === 'Undecided' ? <AlertCircle size={12} className="mr-1"/> : <RefreshCw size={12} className="mr-1"/>}
                                {order.status}
                            </span>
                            <span className="font-mono font-bold text-slate-700 text-sm tracking-tight bg-white/40 px-2 py-0.5 rounded-md">{order.currency} {order.total.toLocaleString()}</span>
                        </div>
                        <div className="mt-3 pt-2 border-t border-slate-200/50 flex items-center gap-4 text-[11px] text-slate-500 pointer-events-none">
                            <div className="flex items-center gap-1.5"><User size={12} className="text-slate-400"/> {order.requestor.split(' ')[0]}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const LabProcurementSystem = () => {
          // State
          const [orders, setOrders] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [selectedOrderId, setSelectedOrderId] = useState(null);
          const [searchQuery, setSearchQuery] = useState('');
          const [statusFilter, setStatusFilter] = useState('All');
          
          // Action State
          const [trackingInput, setTrackingInput] = useState('');
          const [commentInput, setCommentInput] = useState('');
          const [isRejectModalOpen, setIsRejectModalOpen] = useState(false);
          const [rejectReason, setRejectReason] = useState('');
          const [swipeTargetId, setSwipeTargetId] = useState(null);
          
          // AI State
          const [aiAuditResult, setAiAuditResult] = useState(null);
          const [isAiLoading, setIsAiLoading] = useState(false);
          const [aiDraftLoading, setAiDraftLoading] = useState(false);
          
          // Navigation State
          const [activeView, setActiveView] = useState('approvals'); 
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);
          const [toast, setToast] = useState(null);

          // --- Data Loading (With Caching) ---
          const loadData = useCallback(async () => {
            setIsLoading(true);
            
            // 1. Check Cache first
            const cachedData = localStorage.getItem(CACHE_KEY);
            if (cachedData) {
                try {
                    setOrders(JSON.parse(cachedData));
                    setIsLoading(false); 
                } catch (e) {
                    console.error("Cache parse error", e);
                }
            }

            // 2. Fetch fresh from API
            const data = await fetchFromSharePoint();
            
            if (data && Array.isArray(data)) {
                const formattedData = data.map(item => ({
                    id: item.ID,
                    requestor: item.RequesterName?.DisplayName || 'Unknown',
                    group: 'Research Member',
                    requestDate: item.Order_Submitted_Time ? new Date(item.Order_Submitted_Time).toLocaleDateString('en-GB') : 'N/A',
                    total: parseFloat(item.Cost || 0),
                    currency: item.Currency || 'USD',
                    status: item.Decision?.Value || 'Undecided', 
                    priority: 'Normal',
                    description: item.Materials_or_Equipment_Name || 'Unspecified Material',
                    grantId: item.Supply_Code || 'N/A',
                    items: [{
                        id: 1,
                        name: item.Materials_or_Equipment_Name,
                        qty: item.Quantity || 1,
                        unit: item.Unit || 'ea',
                        price: parseFloat(item.Cost || 0),
                        total: parseFloat(item.Cost || 0)
                    }],
                    history: [],
                    justification: item.Reason || '',
                    materialLink: item.Link_of_Materials_or_Equipment,
                    attachmentLink: item.Attachments_URL,
                    trackingUrl: item.The_Order_Tracking_URL,
                    supervisorComment: item.Comments_by_Supervisor
                }));
                
                setOrders(formattedData);
                // Update Cache
                localStorage.setItem(CACHE_KEY, JSON.stringify(formattedData));
            } else {
                // If API fails and no cache, use mock
                if (!cachedData) {
                    setOrders(MOCK_REQUISITIONS);
                    console.log("Using Offline Mode (Mock Data)");
                }
            }
            setIsLoading(false);
          }, []);

          useEffect(() => {
            loadData();
          }, [loadData]);

          // Reset AI state when selection changes
          useEffect(() => {
              if (selectedOrder) {
                  setTrackingInput(selectedOrder.trackingUrl || '');
                  setCommentInput(selectedOrder.supervisorComment || '');
                  setAiAuditResult(null);
              }
          }, [selectedOrderId]);

          // --- Helpers ---
          const showToast = (msg, type = 'success') => {
            setToast({ msg, type });
            setTimeout(() => setToast(null), 3000);
          };

          // --- GEMINI FUNCTIONS ---
          const runAiAudit = async () => {
            if (!selectedOrder) return;
            setIsAiLoading(true);

            // Prepare History Context for Duplicates
            const historyContext = orders
                .filter(o => o.id !== selectedOrder.id)
                .slice(0, 30)
                .map(o => `- ${o.requestDate}: ${o.requestor} ordered ${o.description} ($${o.total})`)
                .join('\n');

            const prompt = `
              As Lab Manager for Soft Matter Photonics (Oxford), audit this requisition.
              
              Current Order:
              Item: ${selectedOrder.description}
              Price: ${selectedOrder.currency} ${selectedOrder.total}
              Requestor: ${selectedOrder.requestor}
              Date: ${selectedOrder.requestDate}
              Justification: "${selectedOrder.justification}"

              Recent History Context:
              ${historyContext}

              Tasks:
              1. Duplicate Check: Does this look like a duplicate of a recent order?
              2. Price Sanity: Is the price significantly higher/lower than expected for this item?
              3. Chemical Safety: Is this a chemical? If yes, provide a Google Search URL for the MSDS.
              4. General Hazards: Identify lasers, high voltage, etc.

              Output JSON: {
                 hazards: string[], 
                 rating: 'Safe'|'Caution'|'High Risk', 
                 summary: string, 
                 duplicates: string[], 
                 priceAlert: string|null,
                 msdsUrl: string|null
              }`;

            try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
              });
              const data = await response.json();
              const result = JSON.parse(data.candidates[0].content.parts[0].text);
              setAiAuditResult(result);
            } catch (e) { showToast("AI Audit failed.", 'error'); } 
            finally { setIsAiLoading(false); }
          };

          const draftRejectionMessage = async () => {
             if (!rejectReason) { showToast("Enter a reason first", "error"); return; }
             setAiDraftLoading(true);
             const prompt = `Draft polite rejection email for PhD student regarding "${selectedOrder.description}". Reason: "${rejectReason}". Tone: Professional mentorship. Max 50 words.`;
             try {
               const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
               });
               const data = await response.json();
               setRejectReason(data.candidates[0].content.parts[0].text.trim());
             } catch(e) { console.error(e); } 
             finally { setAiDraftLoading(false); }
          };

          // --- Filtering ---
          const filteredOrders = useMemo(() => {
            let viewSet = orders;
            if (activeView === 'approvals') {
                viewSet = orders.filter(o => o.status === 'Undecided' || o.status === 'Followup');
            } else if (activeView === 'history') {
                viewSet = orders.filter(o => o.status !== 'Undecided' && o.status !== 'Followup');
            }

            return viewSet.filter(order => {
              const matchesSearch = 
                String(order.id).toLowerCase().includes(searchQuery.toLowerCase()) ||
                order.requestor.toLowerCase().includes(searchQuery.toLowerCase()) ||
                order.description.toLowerCase().includes(searchQuery.toLowerCase());
              
              const matchesStatus = statusFilter === 'All' || order.status === statusFilter;
              return matchesSearch && matchesStatus;
            });
          }, [orders, searchQuery, statusFilter, activeView]);

          // Auto-select
          useMemo(() => {
            if (activeView !== 'vendors' && filteredOrders.length > 0) {
                if (!selectedOrderId || !filteredOrders.find(o => o.id === selectedOrderId)) {
                    setSelectedOrderId(filteredOrders[0].id);
                }
            } else {
                setSelectedOrderId(null);
            }
          }, [filteredOrders, activeView, selectedOrderId]);

          const selectedOrder = useMemo(() => orders.find(o => o.id === selectedOrderId), [orders, selectedOrderId]);

          const stats = useMemo(() => {
            const pending = orders.filter(o => o.status === 'Undecided');
            return {
              pendingCount: pending.length,
              pendingValue: pending.reduce((acc, curr) => acc + curr.total, 0),
              urgentCount: pending.filter(o => o.status === 'Followup').length
            };
          }, [orders]);

          // --- Actions ---
          const handleDecision = async (decision, orderId = null) => {
            const targetId = orderId || selectedOrder?.id;
            if (!targetId) return;
            
            const originalOrders = [...orders];
            const updatedOrders = orders.map(o => 
              o.id === targetId ? { ...o, status: decision, trackingUrl: trackingInput, supervisorComment: commentInput } : o
            );
            setOrders(updatedOrders);
            localStorage.setItem(CACHE_KEY, JSON.stringify(updatedOrders));

            if(decision === 'Denied') setIsRejectModalOpen(false);
            showToast(`Order ${targetId} updated to ${decision}`);

            const success = await sendUpdateToSharePoint(targetId, decision, trackingInput, commentInput);
            if (!success) {
                setOrders(originalOrders);
                localStorage.setItem(CACHE_KEY, JSON.stringify(originalOrders));
                showToast("Sync failed. Check connection.", 'error');
            }
          };

          const onSwipeRight = (id) => handleDecision('Approved', id);
          const onSwipeLeft = (id) => {
             setSwipeTargetId(id);
             setSelectedOrderId(id); 
             setIsRejectModalOpen(true);
          };

          // --- UI Components ---
          const StatusBadge = ({ status }) => {
            const styles = {
              Undecided: 'bg-slate-100/80 text-slate-600 border-slate-200 backdrop-blur-sm',
              Followup: 'bg-amber-100/80 text-amber-700 border-amber-200 backdrop-blur-sm',
              Approved: 'bg-emerald-100/80 text-emerald-700 border-emerald-200 backdrop-blur-sm',
              Ordered: 'bg-blue-100/80 text-blue-700 border-blue-200 backdrop-blur-sm',
              Denied: 'bg-rose-100/80 text-rose-700 border-rose-200 backdrop-blur-sm',
              Finished: 'bg-gray-100/80 text-gray-600 border-gray-200 backdrop-blur-sm'
            };
            
            const icons = {
              Undecided: <AlertCircle size={12} className="mr-1.5"/>,
              Followup: <RefreshCw size={12} className="mr-1.5"/>,
              Denied: <XCircle size={12} className="mr-1.5"/>,
              Default: <CheckCircle2 size={12} className="mr-1.5"/>
            };

            return (
              <span className={`flex items-center w-fit px-2.5 py-1 rounded-full text-[10px] font-semibold border shadow-sm ${styles[status] || 'bg-slate-100'}`}>
                {icons[status] || icons.Default}
                {status}
              </span>
            );
          };

          return (
            <div className="flex h-screen font-sans text-slate-900 overflow-hidden">
              
              {/* --- Sidebar --- */}
              <aside className={`glass-sidebar fixed inset-y-0 left-0 z-30 w-72 text-slate-300 flex flex-col transition-transform duration-300 lg:translate-x-0 lg:static shrink-0 shadow-2xl ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                <div className="h-32 flex items-center px-6 border-b border-white/10 justify-between">
                    <div className="w-full flex flex-col items-start">
                        <div className="w-full h-16 flex items-center justify-start overflow-hidden mb-2">
                            <EngineeringLogo />
                        </div>
                        <span className="text-[10px] text-indigo-300 uppercase tracking-wider font-semibold mt-1 pl-1">Soft Matter Photonics Group</span>
                    </div>
                    <button onClick={() => setIsSidebarOpen(false)} className="lg:hidden text-slate-400 hover:text-white transition-colors absolute top-4 right-4">
                        <X size={20}/>
                    </button>
                </div>

                <nav className="flex-1 py-8 px-4 space-y-3">
                  <div className="px-2 text-[10px] font-bold uppercase text-slate-400 mb-2 tracking-wider flex items-center gap-2">
                     <Layers size={10} /> Procurement
                  </div>
                  
                  <button onClick={() => setActiveView('approvals')} className={`w-full flex items-center px-4 py-3.5 rounded-2xl text-sm font-medium transition-all duration-300 group ${activeView === 'approvals' ? 'bg-indigo-500/20 text-white border border-indigo-500/30 shadow-[0_0_20px_rgba(99,102,241,0.15)]' : 'hover:bg-white/5 hover:text-white text-slate-400 border border-transparent'}`}>
                    <CheckCircle2 size={18} className={`mr-3 transition-colors ${activeView === 'approvals' ? 'text-indigo-400' : 'text-slate-500 group-hover:text-white'}`} /> 
                    Approvals
                    {stats.pendingCount > 0 && <span className="ml-auto bg-indigo-500 text-white text-[10px] font-bold py-0.5 px-2 rounded-full shadow-lg min-w-[24px] text-center animate-pulse">{stats.pendingCount}</span>}
                  </button>
                  
                  <button onClick={() => setActiveView('history')} className={`w-full flex items-center px-4 py-3.5 rounded-2xl text-sm font-medium transition-all duration-300 ${activeView === 'history' ? 'bg-indigo-500/20 text-white border border-indigo-500/30 shadow-[0_0_20px_rgba(99,102,241,0.15)]' : 'hover:bg-white/5 hover:text-white text-slate-400 border border-transparent'}`}>
                    <History size={18} className={`mr-3 transition-colors ${activeView === 'history' ? 'text-indigo-400' : 'text-slate-500 group-hover:text-white'}`} /> 
                    History
                  </button>
                  
                  <div className="px-2 text-[10px] font-bold uppercase text-slate-400 mt-8 mb-2 tracking-wider flex items-center gap-2">
                     <Beaker size={10} /> Admin
                  </div>

                  <button className="w-full flex items-center px-4 py-3.5 rounded-2xl text-sm font-medium text-slate-400 hover:bg-white/5 hover:text-white border border-transparent transition-all">
                     <User size={18} className="mr-3 text-slate-500 group-hover:text-white"/> Lab Members
                  </button>
                </nav>

                <div className="p-4 m-4 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-md">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold border-2 border-white/20 shadow-inner">
                        <GraduationCap size={18} />
                    </div>
                    <div className="flex flex-col">
                      <p className="text-xs font-bold text-white">Prof. Supervisor</p>
                      <p className="text-[10px] text-slate-400">Head of Group</p>
                    </div>
                  </div>
                </div>
              </aside>

              {/* --- Main Content --- */}
              <main className="flex-1 flex flex-col min-w-0 relative">
                
                {/* Top Header */}
                <header className="h-20 glass-panel border-b-0 border-x-0 border-t-0 flex items-center justify-between px-8 shrink-0 z-10 sticky top-0 m-4 rounded-2xl mx-6">
                  <div className="flex items-center">
                    <button onClick={() => setIsSidebarOpen(true)} className="mr-4 lg:hidden p-2 hover:bg-white/50 rounded-xl text-slate-600 transition-colors">
                        <Menu size={20} />
                    </button>
                    <div>
                        <h1 className="text-xl font-bold text-slate-800 tracking-tight drop-shadow-sm">
                            {activeView === 'approvals' ? 'SMP Order System' : 'Processed Orders'}
                        </h1>
                        <p className="text-xs text-slate-500 mt-0.5 font-medium">
                            {activeView === 'approvals' ? 'Review and approve pending lab orders' : 'Archive of all past transactions'}
                        </p>
                    </div>
                  </div>
                  <div className="flex items-center space-x-3">
                    <button 
                        onClick={() => { localStorage.removeItem(CACHE_KEY); loadData(); }} 
                        className={`p-2.5 rounded-xl border border-white/50 bg-white/30 text-slate-500 hover:text-indigo-600 hover:bg-white/60 transition-all shadow-sm ${isLoading ? 'animate-spin text-indigo-600' : ''}`}
                        title="Force Sync"
                    >
                       <RefreshCw size={18} />
                    </button>
                  </div>
                </header>

                {/* Content Area */}
                <div className="flex-1 flex overflow-hidden px-6 pb-6 pt-2 gap-6">
                    {/* List Column */}
                    <div className="w-2/5 flex flex-col min-w-[340px]">
                        {/* Filter Bar */}
                        <div className="glass-panel rounded-t-2xl border-b-0 p-4 flex justify-between items-center">
                            <div className="flex items-center gap-2 px-1">
                                <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Requests</span>
                                <span className="bg-indigo-100/80 text-indigo-700 text-[10px] font-bold px-2 py-0.5 rounded-full border border-indigo-200/50">{filteredOrders.length}</span>
                            </div>
                            <div className="relative group">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors" size={14} />
                                <input 
                                    type="text" 
                                    placeholder="Search ID, Material..." 
                                    className="glass-input pl-9 pr-3 py-2 rounded-xl text-xs w-48 focus:outline-none placeholder:text-slate-400 text-slate-700"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                />
                            </div>
                        </div>
                        
                        {/* Order List */}
                        <div className="glass-panel border-t-0 rounded-b-2xl shadow-sm overflow-hidden flex-1 overflow-y-auto relative">
                            {filteredOrders.map((order, idx) => (
                                <SwipeableOrderCard 
                                    key={order.id}
                                    order={order}
                                    selected={selectedOrderId === order.id}
                                    onClick={() => setSelectedOrderId(order.id)}
                                    onSwipeRight={onSwipeRight}
                                    onSwipeLeft={onSwipeLeft}
                                    enabled={activeView === 'approvals'}
                                    index={idx}
                                />
                            ))}
                            
                            {filteredOrders.length === 0 && (
                                <div className="h-full flex flex-col items-center justify-center text-slate-400 p-8 min-h-[200px]">
                                    <div className="bg-white/40 p-4 rounded-full mb-3 shadow-inner">
                                        <Briefcase size={24} className="opacity-40" />
                                    </div>
                                    <p className="text-xs font-medium">No matching requisitions</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Detail Panel */}
                    <div className="flex-1 glass-panel rounded-2xl shadow-xl flex flex-col overflow-hidden relative animate-fade-in-up" style={{animationDelay: '100ms'}}>
                        {selectedOrder ? (
                        <>
                            {/* Detail Header */}
                            <div className="p-8 border-b border-slate-200/50 bg-white/30 backdrop-blur-md sticky top-0 z-20">
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <div className="flex items-center gap-3 mb-3">
                                            <h1 className="text-2xl font-bold text-slate-800 leading-tight drop-shadow-sm">{selectedOrder.description}</h1>
                                            <StatusBadge status={selectedOrder.status} />
                                        </div>
                                        <div className="flex flex-wrap gap-2 text-xs text-slate-500">
                                            <span className="flex items-center bg-white/60 px-3 py-1.5 rounded-lg font-medium text-slate-600 border border-white/80 shadow-sm">
                                                <FileText size={12} className="mr-2 text-slate-400"/> {selectedOrder.id}
                                            </span>
                                            <span className="flex items-center bg-indigo-50/80 text-indigo-700 px-3 py-1.5 rounded-lg font-mono font-medium border border-indigo-100/50 shadow-sm">
                                                <Building2 size={12} className="mr-2"/> {selectedOrder.grantId}
                                            </span>
                                        </div>
                                    </div>
                                    <div className="text-right bg-white/60 px-5 py-3 rounded-xl border border-white/80 shadow-sm">
                                        <div className="text-3xl font-bold text-slate-800 tracking-tight">{selectedOrder.currency} {selectedOrder.total.toLocaleString()}</div>
                                        <div className="text-[10px] text-slate-400 uppercase tracking-wider font-bold mt-1">Total Est. Cost</div>
                                    </div>
                                </div>

                                {/* AI Audit Block */}
                                <div className="mb-6">
                                    {!aiAuditResult ? (
                                        <button 
                                            onClick={runAiAudit}
                                            disabled={isAiLoading}
                                            className="w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-indigo-50/50 to-purple-50/50 border border-indigo-100/50 text-indigo-700 rounded-xl text-xs font-bold hover:shadow-md hover:from-white hover:to-white transition-all disabled:opacity-50 active:scale-[0.99]"
                                        >
                                            {isAiLoading ? <Loader2 size={16} className="animate-spin" /> : <Sparkles size={16} className="text-purple-500" />}
                                            {isAiLoading ? 'Analyzing Requisition...' : 'Run AI Safety & Compliance Audit'}
                                        </button>
                                    ) : (
                                        <div className="bg-gradient-to-br from-white/80 to-purple-50/30 border border-purple-100 rounded-xl p-5 shadow-sm animate-fade-in-up space-y-3">
                                            <div className="flex justify-between items-start">
                                                <h3 className="text-xs font-bold text-purple-800 flex items-center gap-2">
                                                    <Sparkles size={14} /> AI Analysis Report
                                                </h3>
                                                <span className={`text-[10px] font-bold px-2.5 py-1 rounded-full border ${
                                                    aiAuditResult.rating === 'Safe' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' :
                                                    aiAuditResult.rating === 'Caution' ? 'bg-amber-50 text-amber-700 border-amber-200' :
                                                    'bg-rose-50 text-rose-700 border-rose-200'
                                                }`}>
                                                    {aiAuditResult.rating}
                                                </span>
                                            </div>
                                            
                                            <p className="text-xs text-slate-600 leading-relaxed">{aiAuditResult.summary}</p>
                                            
                                            {/* New AI Fields */}
                                            <div className="grid grid-cols-2 gap-2 pt-1">
                                                {aiAuditResult.priceAlert && (
                                                    <div className="bg-amber-50/80 border border-amber-100 p-2 rounded-lg text-[10px] text-amber-800 flex gap-2 items-start">
                                                        <TrendingUp size={12} className="shrink-0 mt-0.5"/> {aiAuditResult.priceAlert}
                                                    </div>
                                                )}
                                                {aiAuditResult.duplicates && aiAuditResult.duplicates.length > 0 && (
                                                    <div className="bg-blue-50/80 border border-blue-100 p-2 rounded-lg text-[10px] text-blue-800 flex gap-2 items-start">
                                                        <History size={12} className="shrink-0 mt-0.5"/> 
                                                        <div>Possible Duplicates: {aiAuditResult.duplicates.join(", ")}</div>
                                                    </div>
                                                )}
                                                {aiAuditResult.msdsUrl && (
                                                    <a href={aiAuditResult.msdsUrl} target="_blank" className="bg-slate-100 hover:bg-slate-200 border border-slate-200 p-2 rounded-lg text-[10px] text-slate-600 flex gap-2 items-center transition-colors col-span-2">
                                                        <FileWarning size={12} /> View Material Safety Data Sheet (MSDS)
                                                    </a>
                                                )}
                                            </div>

                                            {aiAuditResult.hazards && aiAuditResult.hazards.length > 0 && (
                                                <div className="flex flex-wrap gap-1.5 pt-1">
                                                    {aiAuditResult.hazards.map((h, i) => (
                                                        <span key={i} className="px-2 py-0.5 bg-rose-50 text-rose-700 text-[10px] font-medium rounded-md border border-rose-100">
                                                            ⚠️ {h}
                                                        </span>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Supervisor Controls Area */}
                                <div className="bg-white/40 p-5 rounded-2xl border border-white/50 shadow-inner space-y-4">
                                    <div className="grid grid-cols-2 gap-5">
                                        <div>
                                            <label className="block text-[10px] font-bold text-slate-500 uppercase mb-2 ml-1 tracking-wider">Supervisor Comments</label>
                                            <input 
                                                type="text" 
                                                className="glass-input w-full text-xs p-3 rounded-xl text-slate-700 placeholder:text-slate-400"
                                                placeholder="Add internal notes here..."
                                                value={commentInput}
                                                onChange={(e) => setCommentInput(e.target.value)}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-[10px] font-bold text-slate-500 uppercase mb-2 ml-1 tracking-wider">Tracking / URL</label>
                                            <input 
                                                type="text" 
                                                className="glass-input w-full text-xs p-3 rounded-xl text-slate-700 placeholder:text-slate-400"
                                                placeholder="e.g. https://courier.com/track/..."
                                                value={trackingInput}
                                                onChange={(e) => setTrackingInput(e.target.value)}
                                            />
                                        </div>
                                    </div>
                                    
                                    {/* Action Buttons */}
                                    {activeView === 'approvals' && (
                                        <div className="flex gap-3 pt-2">
                                            <button onClick={() => handleDecision('Approved')} className="flex-1 bg-gradient-to-b from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 text-white py-3 rounded-xl text-xs font-bold transition-all flex justify-center items-center gap-2 shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/30 active:scale-[0.98]">
                                                <CheckCircle2 size={16} /> Approve
                                            </button>
                                            <button onClick={() => handleDecision('Ordered')} className="flex-1 bg-gradient-to-b from-blue-500 to-blue-600 hover:from-blue-400 hover:to-blue-500 text-white py-3 rounded-xl text-xs font-bold transition-all flex justify-center items-center gap-2 shadow-lg shadow-blue-500/20 hover:shadow-blue-500/30 active:scale-[0.98]">
                                                <Truck size={16} /> Mark Ordered
                                            </button>
                                            <button onClick={() => handleDecision('Followup')} className="flex-1 bg-gradient-to-b from-amber-400 to-amber-500 hover:from-amber-300 hover:to-amber-400 text-white py-3 rounded-xl text-xs font-bold transition-all flex justify-center items-center gap-2 shadow-lg shadow-amber-500/20 hover:shadow-amber-500/30 active:scale-[0.98]">
                                                <AlertCircle size={16} /> Follow-up
                                            </button>
                                            <button onClick={() => { setRejectReason(commentInput); setIsRejectModalOpen(true); }} className="flex-1 bg-white border border-slate-200 text-slate-600 hover:bg-rose-50 hover:text-rose-700 hover:border-rose-200 py-3 rounded-xl text-xs font-bold transition-all flex justify-center items-center gap-2 shadow-sm hover:shadow-md active:scale-[0.98]">
                                                <XCircle size={16} /> Deny
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Detail Content Scrollable */}
                            <div className="flex-1 overflow-y-auto p-8 space-y-8">
                                {/* Items Table */}
                                <div className="glass-panel rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                    <div className="bg-white/40 px-6 py-3 border-b border-slate-100 flex items-center gap-2">
                                        <Microscope size={14} className="text-indigo-500"/>
                                        <h3 className="text-xs font-bold text-slate-700 uppercase tracking-wider">Requisition Items</h3>
                                    </div>
                                    <table className="w-full text-xs text-left">
                                        <thead className="bg-white/20 text-slate-500 font-semibold border-b border-slate-100">
                                            <tr>
                                                <th className="px-6 py-3">Item Description</th>
                                                <th className="px-6 py-3 text-right">Qty</th>
                                                <th className="px-6 py-3 text-right">Unit Price</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50/50">
                                            {selectedOrder.items.map((item, idx) => (
                                                <tr key={idx} className="hover:bg-white/30 transition-colors">
                                                    <td className="px-6 py-4">
                                                        <div className="font-medium text-slate-800 text-sm">{item.name}</div>
                                                        {item.pn && <div className="text-slate-400 text-[10px] mt-0.5 font-mono">PN: {item.pn}</div>}
                                                    </td>
                                                    <td className="px-6 py-4 text-right text-slate-600 font-medium">{item.qty} {item.unit}</td>
                                                    <td className="px-6 py-4 text-right text-slate-600 font-mono">{item.price}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Metadata Grid */}
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="p-6 glass-panel rounded-2xl shadow-sm hover:shadow-md transition-all">
                                        <h3 className="text-[10px] font-bold uppercase text-slate-400 mb-4 flex items-center gap-2">
                                            <LinkIcon size={12} /> Resources
                                        </h3>
                                        <div className="flex flex-col gap-3">
                                            {selectedOrder.materialLink ? (
                                                <a href={selectedOrder.materialLink} target="_blank" rel="noreferrer" className="text-xs text-indigo-600 hover:text-indigo-800 font-medium hover:underline flex items-center gap-3 p-3 rounded-xl bg-indigo-50/30 border border-indigo-100/50 transition-colors hover:bg-indigo-50/60">
                                                    <div className="p-1.5 bg-indigo-100 rounded-lg"><LinkIcon size={14}/></div> 
                                                    View Material Page
                                                </a>
                                            ) : <span className="text-xs text-slate-400 italic pl-1">No material link provided</span>}
                                            
                                            {selectedOrder.attachmentLink ? (
                                                <a href={selectedOrder.attachmentLink} target="_blank" rel="noreferrer" className="text-xs text-indigo-600 hover:text-indigo-800 font-medium hover:underline flex items-center gap-3 p-3 rounded-xl bg-indigo-50/30 border border-indigo-100/50 transition-colors hover:bg-indigo-50/60">
                                                    <div className="p-1.5 bg-indigo-100 rounded-lg"><Download size={14}/></div> 
                                                    Download Quote
                                                </a>
                                            ) : <span className="text-xs text-slate-400 italic pl-1">No attachments</span>}
                                        </div>
                                    </div>
                                    <div className="p-6 glass-panel rounded-2xl shadow-sm hover:shadow-md transition-all flex flex-col">
                                        <h3 className="text-[10px] font-bold uppercase text-slate-400 mb-4 flex items-center gap-2">
                                            <ScrollText size={12} /> Justification
                                        </h3>
                                        <div className="text-xs text-slate-600 leading-relaxed bg-white/40 p-4 rounded-xl border border-white/60 h-full shadow-inner">
                                            {selectedOrder.justification || "No justification provided."}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </>
                        ) : (
                        <div className="flex-1 flex items-center justify-center text-slate-400 flex-col">
                            <div className="w-24 h-24 bg-white/30 rounded-3xl shadow-sm border border-white/40 flex items-center justify-center mb-6 animate-pulse">
                                <Zap size={48} className="text-slate-300/50" />
                            </div>
                            <p className="text-sm font-medium text-slate-500">Select a requisition to review details</p>
                        </div>
                        )}
                    </div>
                </div>
              </main>

              {/* Modal */}
              {isRejectModalOpen && (
                <div className="fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in-up">
                  <div className="glass-panel w-full max-w-md p-8 rounded-3xl shadow-2xl border-white/80">
                    <div className="mb-6 flex items-center gap-4">
                        <div className="p-4 bg-rose-100/80 rounded-2xl text-rose-600 shadow-sm border border-rose-200"><XCircle size={28}/></div>
                        <div>
                            <h2 className="text-xl font-bold text-slate-800">Deny Request</h2>
                            <p className="text-xs text-slate-500 mt-1">This action will notify the researcher.</p>
                        </div>
                    </div>
                    
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2.5 ml-1 tracking-wide">Reason for Denial</label>
                    <textarea
                      className="glass-input w-full rounded-2xl p-4 text-sm text-slate-700 outline-none min-h-[140px] mb-6 resize-none placeholder:text-slate-400"
                      value={rejectReason}
                      onChange={(e) => setRejectReason(e.target.value)}
                      placeholder="e.g. Insufficient grant funds, item already in stock..."
                      autoFocus
                    ></textarea>
                    
                    {/* AI Auto-Draft Button */}
                    <div className="flex flex-col gap-4">
                        <button 
                           onClick={draftRejectionMessage}
                           disabled={aiDraftLoading}
                           className="text-xs font-bold text-purple-600 flex items-center justify-center gap-2 hover:text-purple-800 transition-all disabled:opacity-50 hover:bg-purple-50 py-2 rounded-xl border border-transparent hover:border-purple-100"
                        >
                           {aiDraftLoading ? <Loader2 size={14} className="animate-spin"/> : <Sparkles size={14}/>}
                           Use AI to draft polite explanation
                        </button>

                        <div className="flex gap-3 pt-2 border-t border-slate-200/50">
                          <button 
                            onClick={() => setIsRejectModalOpen(false)}
                            className="flex-1 py-3 text-slate-600 hover:bg-slate-100 rounded-xl font-medium text-xs transition-colors"
                          >
                            Cancel
                          </button>
                          <button 
                            onClick={() => handleDecision('Denied')}
                            disabled={!rejectReason.trim()}
                            className="flex-1 py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-xl font-bold text-xs shadow-lg shadow-rose-200 disabled:opacity-50 disabled:shadow-none transition-all active:scale-[0.98]"
                          >
                            Confirm Denial
                          </button>
                        </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Toast */}
              {toast && (
                <div className={`fixed bottom-8 right-8 px-6 py-4 rounded-2xl shadow-2xl text-white text-sm font-medium flex items-center animate-fade-in-up z-50 border border-white/10 backdrop-blur-md ${toast.type === 'error' ? 'bg-rose-600/90' : 'bg-slate-800/90'}`}>
                    {toast.type === 'error' ? <AlertCircle size={20} className="mr-3"/> : <CheckCircle2 size={20} className="mr-3"/>}
                    {toast.msg}
                </div>
              )}

            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<LabProcurementSystem />);
    </script>
</body>
</html>
