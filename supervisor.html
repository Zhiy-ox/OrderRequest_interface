<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Supervisor Approval</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <style>
    /* This class ensures newline characters in plain text become line breaks. */
    .preserve-lines {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row">
      <div class="col-12">
        <h2>Supervisor Dashboard</h2>
        <p>Review the order requests (with attachments).</p>

        <!-- Button to load requests from Power Automate/SharePoint -->
        <button id="loadBtn" class="btn btn-success mb-3">Load Requests</button>

        <table
          class="table table-bordered table-striped"
          id="requestsTable"
          style="table-layout: fixed; width: 100%;"
        >
          <colgroup>
            <col style="width: 50px;" />
            <col style="width: 150px;" />
            <col style="width: 200px;" />
            <col style="width: 80px;" />
            <col style="width: 80px;" />
            <col style="width: 400px;" />
            <col style="width: 200px;" />
            <col style="width: 200px;" />
            <col style="width: 160px;" />
            <col style="width: 150px;" />
            <col style="width: 80px;" />
            <col style="width: 80px;" />
            <col style="width: 120px;" />
            <col style="width: 200px;" />
            <col style="width: 100px;" /> <!-- Attachments column -->
            <col style="width: 100px;" />
          </colgroup>

          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Requester Name</th>
              <th>Materials or Equipment Name</th>
              <th>Quantity</th>
              <th>Unit</th>
              <th>Reason</th>
              <th>Links of Materials or Equipment</th>
              <th>The Order Tracking URL</th>
              <th>Order Submitted Time</th>
              <th>Decision</th>
              <th>Cost</th>
              <th>Currency</th>
              <th>Supply_Code</th>
              <th>Comments by Supervisor</th>
              <th>Attachments</th> <!-- NEW column -->
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamically populated rows -->
          </tbody>
        </table>

        <div id="responseMessage" class="text-danger fw-bold"></div>
      </div>
    </div>
  </div>

  <!-- Optional Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    // ---------------------------------------------------------
    // 1) URLs for fetching data and updating items
    // ---------------------------------------------------------
    const LIST_FETCH_URL = "https://prod-108.westeurope.logic.azure.com:443/workflows/82ca49f033d84aa8807da35568348a60/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=OnER2k0ivse9M9rXp7mwortbxjGFVuPvn1OZsMHqhXs";  // e.g. "https://.../invoke?..."
    const UPDATE_FLOW_URL = "https://prod-168.westeurope.logic.azure.com:443/workflows/0d2ecc042a8745f58b40ae8e35cdc47b/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=am6h8CwzxHZWuBRAmtmhVTdaUVkBihbJP7X4LWsV3Xo"; // e.g. "https://.../invoke?..."

    // DOM references
    const loadBtn = document.getElementById("loadBtn");
    const requestsTableBody = document.querySelector("#requestsTable tbody");
    const responseMessage = document.getElementById("responseMessage");

    // Potential decisions for the "Decision" field
    const possibleDecisions = [
      "Undecided",
      "Followup",
      "Finished",
      "Ordered",
      "Denied",
      "Approved"
    ];

    // ---------------------------------------------------------
    // 2) Helper function to build attachment links
    // ---------------------------------------------------------
    /**
     * Convert an array of attachments (Name, Url) into
     * a string of hyperlinks (one per line).
     */
    function buildAttachmentsHyperlinks(attachments) {
      if (!attachments || attachments.length === 0) {
        return "No attachments";
      }
      // Create an <a> tag for each attachment
      const links = attachments.map(att => {
        return `<a href="${att.Url}" target="_blank">${att.Name}</a>`;
      });
      // Join with a <br/> to have each link on its own line
      return links.join("<br/>");
    }

    // ---------------------------------------------------------
    // 3) Load and display existing requests
    // ---------------------------------------------------------
    loadBtn.addEventListener("click", async () => {
      responseMessage.textContent = ""; // Clear old messages
      try {
        const res = await fetch(LIST_FETCH_URL);
        if (!res.ok) {
          throw new Error(`Failed to fetch requests. Status code: ${res.status}`);
        }

        // If your Flow returns { "value": [ ... ] }, parse accordingly
        const dataObj = await res.json();
        const data = dataObj.value || [];  // e.g. { "value": [...] }

        // Sort the items by Decision
        data.sort((a, b) => {
          const decisionA = a.Decision?.Value || "Undecided";
          const decisionB = b.Decision?.Value || "Undecided";
          const indexA = possibleDecisions.indexOf(decisionA);
          const indexB = possibleDecisions.indexOf(decisionB);
          // If not found, push to end
          const safeA = indexA === -1 ? possibleDecisions.length : indexA;
          const safeB = indexB === -1 ? possibleDecisions.length : indexB;
          return safeA - safeB;
        });

        // Clear existing rows
        requestsTableBody.innerHTML = "";

        // Populate table rows
        data.forEach(item => {
          const row = document.createElement("tr");
          row.setAttribute("data-id", item.ID || "");

          // Format the submission time if it exists
          let submittedTime = "";
          if (item.Order_Submitted_Time) {
            const dt = new Date(item.Order_Submitted_Time);
            submittedTime = dt.toLocaleString("en-US", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
              hour12: true
            });
          }

          // Build attachments HTML
          const attachmentsHtml = buildAttachmentsHyperlinks(item.Attachments);

          // Construct the row's inner HTML
          const rowHtml = `
            <td>${item.ID || ""}</td>
            <td>${item.RequesterName?.DisplayName || ""}</td>
            <td>${item.Materials_or_Equipment_Name || ""}</td>
            <td>${item.Quantity ?? "No quantity"}</td>
            <td>${item.Unit || "No unit provided"}</td>
            <td class="preserve-lines">${item.Reason || "No Proposal Provided"}</td>
            <td>${item.Link_of_Materials_or_Equipment || "No Link Provided"}</td>
            <td class="trackingUrlCell">${item.The_Order_Tracking_URL || ""}</td>
            <td>${submittedTime}</td>
            <td class="decisionCell">${item.Decision?.Value || "Undecided"}</td>
            <td>${item.Cost ?? "No cost provided"}</td>
            <td>${item.Currency || ""}</td>
            <td>${item.Supply_Code || "No supply code provided"}</td>
            <td class="commentsCell">${item.Comments_by_Supervisor || ""}</td>
            <td class="attachmentsCell">${attachmentsHtml}</td> <!-- NEW attachments column -->
            <td>
              <button class="btn btn-sm btn-primary editBtn">Edit</button>
              <button class="btn btn-sm btn-success saveBtn" style="display:none;">Save</button>
            </td>
          `;
          row.innerHTML = rowHtml;
          requestsTableBody.appendChild(row);
        });

        // Attach event listeners for Edit/Save after creating rows
        addRowListeners();
      } catch (err) {
        console.error(err);
        responseMessage.textContent = "Error loading requests: " + err.message;
      }
    });

    // ---------------------------------------------------------
    // 4) Add listeners to Edit/Save buttons
    // ---------------------------------------------------------
    function addRowListeners() {
      const allRows = document.querySelectorAll("#requestsTable tbody tr");
      allRows.forEach(row => {
        const editBtn = row.querySelector(".editBtn");
        const saveBtn = row.querySelector(".saveBtn");

        editBtn.addEventListener("click", () => {
          const trackingCell = row.querySelector(".trackingUrlCell");
          const decisionCell = row.querySelector(".decisionCell");
          const commentsCell = row.querySelector(".commentsCell");

          // Current values
          const currentTrackingUrl = trackingCell.textContent.trim();
          const currentDecision = decisionCell.textContent.trim();
          const currentComments = commentsCell.textContent.trim();

          // Convert tracking URL to an input
          trackingCell.innerHTML = `<input type="text" class="form-control" value="${currentTrackingUrl}" />`;

          // Convert decision to a dropdown
          let selectHtml = `<select class="form-select">`;
          possibleDecisions.forEach(dec => {
            const selected = dec === currentDecision ? "selected" : "";
            selectHtml += `<option value="${dec}" ${selected}>${dec}</option>`;
          });
          selectHtml += `</select>`;
          decisionCell.innerHTML = selectHtml;

          // Convert comments to a textarea
          commentsCell.innerHTML = `<textarea class="form-control" rows="3">${currentComments}</textarea>`;

          // Toggle buttons
          editBtn.style.display = "none";
          saveBtn.style.display = "inline-block";
        });

        saveBtn.addEventListener("click", async () => {
          const trackingCell = row.querySelector(".trackingUrlCell");
          const decisionCell = row.querySelector(".decisionCell");
          const commentsCell = row.querySelector(".commentsCell");

          // Grab new values
          const newTrackingUrl = trackingCell.querySelector("input").value.trim();
          const newDecision = decisionCell.querySelector("select").value.trim();
          const newComments = commentsCell.querySelector("textarea").value.trim();

          // Row ID
          const rowId = row.getAttribute("data-id");

          try {
            responseMessage.textContent = "Updating the item...";

            // Build payload for your Update Flow
            const payload = {
              ID: rowId,
              The_Order_Tracking_URL: newTrackingUrl,
              Decision: newDecision,
              Comments_by_Supervisor: newComments
              // Add more fields if your flow expects them
            };

            // POST to the update flow
            const res = await fetch(UPDATE_FLOW_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            if (!res.ok) {
              throw new Error(`Update request failed with status ${res.status}`);
            }

            responseMessage.textContent = `Item #${rowId} updated successfully.`;

            // Revert the cells to plain text
            trackingCell.textContent = newTrackingUrl || "Please insert Tracking URL";
            decisionCell.textContent = newDecision || "Undecided";
            commentsCell.textContent = newComments || "";

            // Toggle buttons
            editBtn.style.display = "inline-block";
            saveBtn.style.display = "none";
          } catch (error) {
            console.error(error);
            responseMessage.textContent = `Error updating item #${rowId}: ${error.message}`;
          }
        });
      });
    }
  </script>
</body>
</html>
